<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Ledger Consolidator (Excel Upload)</title>
<style>
body.theme-blue {
  --primary: #2563eb;
  --primary-dark: #1e40af;
  --bg1: #eef2ff;
  --bg2: #e0e7ff;
}

body.theme-green {
  --primary: #16a34a;
  --primary-dark: #166534;
  --bg1: #ecfdf5;
  --bg2: #dcfce7;
}

:root {
  --primary: #2563eb;
  --primary-dark: #1e40af;
  --bg1: #eef2ff;
  --bg2: #e0e7ff;
  --card: #ffffff;
  --border: #e5e7eb;
  --text: #1f2937;
  --muted: #6b7280;
  --danger: #dc2626;
}

/* ðŸŒˆ Background */
body {
  font-family: "Segoe UI", system-ui, Arial, sans-serif;
  background: radial-gradient(circle at top left, var(--bg1), var(--bg2));
  min-height: 100vh;
  margin: 0;
  padding: 30px 16px;
  color: var(--text);

  /* Center everything */
  display: flex;
  justify-content: center;
}

/* Main container feel */
body > * {
  width: 100%;
}

/* Wrap content in center */
.container {
  max-width: 1100px;
  margin: 0 auto;
}

/* Heading */
h3 {
  margin: 0 0 18px 0;
  font-size: 20px;
  font-weight: 600;
}

/* Top bar alignment stays */
.topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
  margin-bottom: 18px;
  flex-wrap: wrap;
}

/* Cards */
.cards {
  display: flex;
  gap: 14px;
}

.card {
  background: var(--card);
  border-radius: 12px;
  padding: 16px 20px;
  min-width: 170px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

/* Inputs & buttons */
input[type="file"], #search {
  padding: 9px 10px;
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
}

button {
  padding: 9px 18px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #fff;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  box-shadow: 0 6px 16px rgba(37,99,235,0.35);
  transition: all 0.2s ease;
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 24px rgba(37,99,235,0.45);
}

/* ðŸ“Š Table container centered */
.table-wrap {
  display: flex;
  justify-content: center;
}

/* Table */
table {
  width: 100%;
  max-width: 900px;   /* ðŸ‘ˆ table middle me aur compact */
  border-collapse: separate;
  border-spacing: 0;
  background: var(--card);
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 14px 32px rgba(0,0,0,0.12);
}

thead th {
  background: linear-gradient(135deg, #f8fafc, #e5e7eb);
  color: var(--muted);
  padding: 14px;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

tbody td {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
}

tbody tr:nth-child(even) {
  background: #f9fafb;
}

tbody tr:hover {
  background: #eef2ff;
}

/* Negative row */
.neg {
  background: #fee2e2 !important;
}

.neg td:last-child {
  color: var(--danger);
  font-weight: 600;
}

/* ðŸŒ™ Dark mode adjust */
body.dark {
  --bg1: #020617;
  --bg2: #020617;
  --card: #020617;
  --border: #1e293b;
  --text: #e5e7eb;
  --muted: #9ca3af;
}
@media (max-width: 768px) {

  .topbar {
    flex-direction: column;
    align-items: stretch;
  }

  .cards {
    width: 100%;
  }

  .card {
    flex: 1;
    min-width: unset;
    text-align: center;
  }

  .actions {
    width: 100%;
    justify-content: space-between;
  }

  table {
    font-size: 13px;
  }

  thead {
    display: none;
  }

  tbody tr {
    display: block;
    margin-bottom: 12px;
    border-radius: 10px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.1);
  }

  tbody td {
    display: flex;
    justify-content: space-between;
    padding: 10px 14px;
    border-bottom: none;
  }

  tbody td::before {
    content: attr(data-label);
    font-weight: 600;
    color: var(--muted);
  }
}
.card {
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 16px 32px rgba(0,0,0,0.18);
}
body.dark tbody tr {
  background: #020617;
  color: #e5e7eb;
}

body.dark tbody tr:nth-child(even) {
  background: #020617;
}

body.dark tbody tr:hover {
  background: #020617;
}
body.dark .neg {
  background: #3f1d1d !important;
}

body.dark .neg td:last-child {
  color: #fca5a5;
}
/* ===== Dark mode borders ===== */

/* Cards border */
body.dark .card {
  border: 1px solid #1e293b;
  box-shadow: 0 10px 24px rgba(0,0,0,0.6);
}

/* Table outer border */
body.dark table {
  border: 1px solid #1e293b;
  box-shadow: 0 14px 32px rgba(0,0,0,0.7);
}

/* Table header bottom border */
body.dark thead th {
  border-bottom: 1px solid #1e293b;
}

/* Table row separators */
body.dark tbody td {
  border-bottom: 1px solid #1e293b;
}

/* Search + file input border */
body.dark input[type="file"],
body.dark #search {
  background: #020617;
  color: #e5e7eb;
  border: 1px solid #1e293b;
}

/* Export / action buttons border clarity */
body.dark button {
  box-shadow: 0 6px 16px rgba(0,0,0,0.8);
}
/* ===== Theme-based card borders ===== */
body.theme-blue .card {
  border: 1px solid rgba(37, 99, 235, 0.35);
}

body.theme-green .card {
  border: 1px solid rgba(22, 163, 74, 0.35);
}

body.dark.theme-blue .card {
  border: 1px solid #1e40af;
}

body.dark.theme-green .card {
  border: 1px solid #166534;
}
/* ===== Sticky table header ===== */
thead th {
  position: sticky;
  top: 0;
  z-index: 3;
}

/* Dark mode header clarity */
body.dark thead th {
  background: #020617;
}
/* ===== Print layout ===== */
@media print {

  body {
    background: #fff !important;
    color: #000 !important;
  }

  .topbar,
  .actions,
  button,
  #search,
  input[type="file"] {
    display: none !important;
  }

  table {
    box-shadow: none !important;
    border: 1px solid #000;
  }

  th, td {
    border: 1px solid #000 !important;
    color: #000 !important;
    background: #fff !important;
  }

  .neg td:last-child {
    color: #000 !important;
  }
}


</style>
</head>
<body>

<div class="container">

  <h3>Ledger Consolidator (Excel Upload)</h3>

  <div class="actions" style="margin-bottom:16px">
    <input type="file" id="file" accept=".xls,.xlsx">
    <button onclick="exportExcel()">Export to Excel</button>
  </div>

  <!-- Top bar -->
  <div class="topbar">
    <div class="cards">
      <div class="card">
        <div class="label">Total Codes</div>
        <div class="value" id="totalCodes">0</div>
      </div>
      <div class="card">
        <div class="label">Net Amount</div>
        <div class="value" id="grandTotal">0.00</div>
      </div>
    </div>

    <div class="actions">
      <input type="text" id="search" placeholder="Search code...">
      <button onclick="toggleDark()">ðŸŒ™ Dark</button>
      <button onclick="setTheme('blue')">ðŸ”µ Blue</button>
      <button onclick="setTheme('green')">ðŸŸ¢ Green</button>
    </div>
  </div>

  <!-- ðŸ‘‡ TABLE CENTER WRAP -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Code</th>
          <th>Net Amount</th>
        </tr>
      </thead>
      <tbody id="result"></tbody>
    </table>
  </div>

</div>


<script src="xlsx.full.min.js"></script>

<script>
/* ===== Globals ===== */
window.uploadedBaseName = "";
window.lastTotals = {};

/* ===== Excel-formula style extractor ===== */
function extractCodeFromNarration(text) {
  if (!text) return "";

  const s = text.indexOf("Sub.No. :");
  const e = text.indexOf("Sub. Name :");
  if (s !== -1 && e !== -1 && e > s) {
    return text
      .substring(s + "Sub.No. :".length, e)
      .replace(/,/g, "")
      .trim();
  }

  const m = text.match(/\b[A-Z]{3,6}\d+\b/i);
  return m ? m[0] : "";
}
/* ===== Excel-formula style extractor ===== */
function setTheme(t) {
  document.body.classList.remove("theme-blue","theme-green");
  document.body.classList.add("theme-" + t);
}

/* ===== SINGLE file handler (FIXED) ===== */
document.getElementById("file").addEventListener("change", function (e) {
  const file = e.target.files[0];
  if (!file) return;

  // store base filename ONCE
  window.uploadedBaseName = file.name
    .replace(/\.[^/.]+$/, "");   // full name without extension

  const reader = new FileReader();
  reader.onload = function (evt) {

    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];

    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

    const totals = {};
    window.lastTotals = totals;

    rows.forEach(r => {
      // Ledger format:
      // 0 Date | 1 Time | 2 Txn Type | 3 Narration | 4 Remarks | 5 In | 6 Out | 7 Balance
      const narration = String(r[3] || r[4] || "");
      const code = extractCodeFromNarration(narration);
      if (!code) return;

      const inAmt  = parseFloat(String(r[5]).replace(/,/g,"")) || 0;
      const outAmt = parseFloat(String(r[6]).replace(/,/g,"")) || 0;

      if (!totals[code]) totals[code] = 0;

      // ðŸ”’ BUSINESS RULE
      if (outAmt > 0) totals[code] += outAmt; // Package
      if (inAmt  > 0) totals[code] -= inAmt;  // Refund
    });

    renderTable(totals);
  };

  reader.readAsArrayBuffer(file);
});

/* ===== Render ===== */
function renderTable(totals) {
  let html = "";
  let count = 0;
  let sum = 0;

  Object.keys(totals).sort().forEach(k => {
    const v = totals[k];
    count++;
    sum += v;

    html += `
      <tr class="${v < 0 ? 'neg' : ''}">
        <td data-label="Code">${k}</td>
	<td data-label="Net Amount">${v.toFixed(2)}</td>
      </tr>`;
  });

  document.getElementById("result").innerHTML =
    html || "<tr><td colspan='2'>No valid data</td></tr>";

  animateValue("totalCodes", 0, count);
  animateValue("grandTotal", 0, sum);

}
/* ===== SearchFilter===== */
document.getElementById("search").addEventListener("input", function () {
  const q = this.value.toLowerCase();
  document.querySelectorAll("#result tr").forEach(tr => {
    tr.style.display = tr.textContent.toLowerCase().includes(q) ? "" : "none";
  });
});

/* ===== DarkMode===== */
function toggleDark() {
  document.body.classList.toggle("dark");
}
/* ===== AnimatedValue===== */
function animateValue(id, start, end, duration = 500) {
  const el = document.getElementById(id);
  if (!el) return;

  const startTime = performance.now();

  function tick(now) {
    const p = Math.min((now - startTime) / duration, 1);
    const val = start + (end - start) * p;
    el.textContent = id === "totalCodes"
      ? Math.round(val)
      : val.toFixed(2);

    if (p < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

/* ===== Export ===== */
function exportExcel() {
  if (!window.lastTotals || Object.keys(lastTotals).length === 0) {
    alert("No data to export");
    return;
  }

  const data = [["Code", "Net Amount"]];
  Object.keys(lastTotals).sort().forEach(k => {
    data.push([k, Number(lastTotals[k].toFixed(2))]);
  });

  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Consolidated");

  const base = window.uploadedBaseName || "Consolidated";
  XLSX.writeFile(wb, `${base}.xlsx`);
}
</script>

</body>
</html>
