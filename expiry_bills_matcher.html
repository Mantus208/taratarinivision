<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Expiry vs Bills Matcher</title>

<style>
/* ===== ROOT THEME ===== */
:root{
  --bg: #f1f5f9;
  --card: #ffffff;
  --primary: #2563eb;
  --accent: #16a34a;
  --danger: #dc2626;
  --text: #1f2937;
  --muted: #6b7280;
  --border: #e5e7eb;
}

/* ===== PAGE ===== */
body{
  font-family: "Segoe UI", system-ui, Arial, sans-serif;
  background: var(--bg);
  margin: 0;
  padding: 24px;
  color: var(--text);
}

/* ===== HEADER ===== */
h3{
  margin-bottom: 18px;
  font-size: 22px;
  font-weight: 600;
}

/* ===== DASHBOARD (STICKY) ===== */
.dashboard-wrap{
  position: sticky;
  top: 0;
background: var(--bg);
  z-index: 100;  
  padding-bottom: 10px;
}

.dashboard{
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap: 16px;
}

.dash-card{
  background: var(--card);
  border-radius: 14px;
  padding: 16px 18px;
  border: 1px solid var(--border);
  box-shadow: 0 10px 24px rgba(0,0,0,.08);
}

.dash-label{
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: .04em;
}

.dash-value{
  font-size: 26px;
  font-weight: 600;
}

.dash-card.danger{
  background: #fff1f2;
  border-color: #fecaca;
}

.dash-card.danger .dash-value{
  color: var(--danger);
}

/* ===== UPLOAD BAR ===== */
.upload-bar{
  display: flex;
  align-items: flex-end;
  gap: 14px;
  margin-bottom: 18px;
  flex-wrap: wrap;
}

.upload-item{
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.upload-item label{
  font-size: 12px;
  color: var(--muted);
}

input[type="file"]{
  padding: 6px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--card);
  font-size: 13px;
}

/* ===== SEARCH / ACTIONS ===== */
#searchBox{
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  font-size: 13px;
  min-width: 220px;
}

.upload-actions{
  display: flex;
  gap: 12px;
  margin-left: auto;
}

/* ===== BUTTONS ===== */
button{
  padding: 10px 18px;
  border: none;
  border-radius: 10px;
  background: linear-gradient(135deg,var(--primary),#1e40af);
  color: #fff;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  box-shadow: 0 6px 16px rgba(37,99,235,.35);
  transition: all .2s ease;
}

button:hover{
  transform: translateY(-1px);
  box-shadow: 0 10px 24px rgba(37,99,235,.45);
}

/* ===== TABLE ===== */
table{
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: var(--card);
  border-radius: 14px;
  overflow: hidden;
  table-layout: auto;
  /* ðŸ‘‡ NEW */
  border: 2px solid var(--border);
  box-shadow: 0 14px 32px rgba(0,0,0,.12);
}

thead th{
  background: linear-gradient(135deg,#f8fafc,#e5e7eb);
  color: var(--muted);
  font-size: 13px;
  padding: 14px;
  text-transform: uppercase;
  letter-spacing: .04em;
}
thead th:first-child {
  border-top-left-radius: 12px;
}

thead th:last-child {
  border-top-right-radius: 12px;
}

tbody tr:last-child td:first-child {
  border-bottom-left-radius: 12px;
}

tbody tr:last-child td:last-child {
  border-bottom-right-radius: 12px;
}
tbody td{
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
}

tbody tr:nth-child(even){
  background: #f9fafb;
}

tbody tr:hover{
  background: #eef2ff;
}

/* ===== NEGATIVE ROW ===== */
.neg{
  background: #fee2e2 !important;
}

.neg td:last-child{
  color: var(--danger);
  font-weight: 600;
}

/* ===== INPUT IN TABLE ===== */
input[type="number"]{
  width: 110px;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid var(--border);
  font-size: 13px;
}

/* ===== MODAL ===== */
.modal-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-box{
  background: var(--card);
  width: 92%;
  max-width: 520px;
  max-height: 80vh;
  overflow: auto;
  padding: 18px;
  border-radius: 14px;
  box-shadow: 0 20px 50px rgba(0,0,0,.25);
}

.modal-actions{
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 14px;
}

/* ===== DARK MODE ===== */
body.dark{
  --bg: #020617;
  --card: #020617;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --border: #1e293b;
}

body.dark table,
body.dark .dash-card,
body.dark .modal-box{
  background:#020617;
  color:#e5e7eb;
}

body.dark thead th{
  background:#020617;
  color:#9ca3af;
}
body.dark table{
  border-color: #1e293b;   /* dark border */
}
body.dark .neg{
  background:#3f1d1d !important;
}
body.dark tbody tr:nth-child(even){
  background: #020617;
}

body.dark tbody tr:hover{
  background: #0f172a;   /* soft dark hover */
}
/* ===== PRINT ===== */
@media print{
  body{
    background:#fff !important;
    padding:0;
  }

  .dashboard-wrap,
  .upload-bar,
  button,
  input{
    display:none !important;
  }

  table{
    box-shadow:none;
    border-radius:0;
    font-size:11px;
  }

  th,td{
    border:1px solid #000;
    padding:6px;
  }

  thead th{
    background:#fff;
    color:#000;
  }

  .neg{
    background:#fff !important;
    color:#000;
  }
}

/* ===== MOBILE ===== */
@media(max-width:768px){
  body{ padding:14px; }

  .upload-bar{
    flex-direction:column;
    align-items:stretch;
  }

  .upload-actions{
    margin-left:0;
    justify-content:space-between;
  }

  #searchBox{ width:100%; }
}

.row-tooltip {
  position: fixed;
  z-index: 9999;
  background: #111827;
  color: #f9fafb;
  padding: 10px 12px;
  border-radius: 10px;
  font-size: 13px;
  line-height: 1.4;
  max-width: 320px;
  box-shadow: 0 12px 30px rgba(0,0,0,.35);
  pointer-events: none;
  opacity: 0;
  transform: translateY(6px);
  transition: opacity .15s ease, transform .15s ease;
  white-space: pre-line;
}

.row-tooltip b{
  display:block;
  margin-bottom:6px;
  color:#93c5fd;
}

</style>

</head>
<body>

<div id="rowTooltip" class="row-tooltip"></div>

<h3>Expiry â†” Bills Matcher (Manual Adjust)</h3>

<!-- ===== STICKY DASHBOARD ONLY ===== -->
<div class="dashboard-wrap">
  <div class="dashboard">

    <div class="dash-card">
      <div class="dash-label">Total Customers</div>
      <div class="dash-value" id="dashCustomers">0</div>
    </div>

    <div class="dash-card">
      <div class="dash-label">Total Bills Amount</div>
      <div class="dash-value" id="dashBills">0.00</div>
    </div>

    <div class="dash-card">
      <div class="dash-label">Total Expiry Amount</div>
      <div class="dash-value" id="dashExpiry">0.00</div>
    </div>

    <div class="dash-card danger">
      <div class="dash-label">Non-Match Count</div>
      <div class="dash-value" id="dashNonMatch">0</div>
    </div>

  </div>
</div>

<!-- ===== NORMAL (NON-STICKY) CONTROLS ===== -->
<div class="upload-bar">

  <div class="upload-item">
    <label>Expiry File</label>
    <input type="file" id="expiryFile" accept=".xls,.xlsx">
  </div>

  <div class="upload-item">
    <label>Bills File</label>
    <input type="file" id="billsFile" accept=".xls,.xlsx">
  </div>

  <input type="text" id="searchBox"
         placeholder="Search code / name / user">

  <label class="chk">
    <input type="checkbox" id="filterMismatch">
    Non-Match Only
  </label>

  <div class="upload-actions">
    <button onclick="exportExcel()">ðŸ“¤ Export</button>
    <button onclick="toggleDark()">ðŸŒ™ Dark</button>
  </div>

</div>

<!-- ===== TABLE ===== -->
<table>
  <thead>
    <tr>
      <th>Code</th>
      <th>Sub Name</th>
      <th>User</th>
      <th>Bill Date</th>
      <th>To Date</th>
      <th>Expiry Amount</th>
      <th>Bills Net Amount</th>
      <th>Difference</th>
    </tr>
  </thead>
  <tbody id="out"></tbody>
</table>


<script src="xlsx.full.min.js"></script>

<script>
let expiryMap = {};
let billsMap = {};
let packageMap = {};   // ðŸ”¥ Name â†’ amount
let billAmountMap = {};

/* ===== Helper Function ===== */
function isValidCode(code) {
  return /^[A-Z]{3,6}\d{3,6}$/i.test(code);
}
/* ===== Modal Control ===== */
function openModal(title, html, onApply) {
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalContent").innerHTML = html;

  const btn = document.getElementById("modalApply");
  btn.onclick = () => {
    onApply();
    closeModal();
  };

  document.getElementById("modalOverlay").style.display = "flex";
}

function closeModal() {
  document.getElementById("modalOverlay").style.display = "none";
}
loadSettings();
/* ===== Read Excel helper ===== */
function readExcel(file, callback) {
  const r = new FileReader();
  r.onload = e => {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
    callback(rows);
  };
  r.readAsArrayBuffer(file);
}
function saveSettings() {
  localStorage.setItem("expiryPackageMap", JSON.stringify(packageMap));
  localStorage.setItem("billAmountMap", JSON.stringify(billAmountMap));
}
function loadSettings() {
  const pkg = localStorage.getItem("expiryPackageMap");
  if (pkg) packageMap = JSON.parse(pkg);

  const bills = localStorage.getItem("billAmountMap");
  if (bills) billAmountMap = JSON.parse(bills);
}
/* ===== Expiry file ===== */
document.getElementById("expiryFile").onchange = e => {
  readExcel(e.target.files[0], rows => {

    expiryMap = {};
    const savedPkg = JSON.parse(
      localStorage.getItem("expiryPackageMap") || "{}"
    );
    packageMap = { ...savedPkg };
	const groups = {}; 
    // baseCode â†’ [{ code, packages, toDate, subName }]

    rows.slice(1).forEach(r => {

      const baseCode = String(r[0] || "").trim().toUpperCase();
      if (!isValidCode(baseCode)) return;

      const pkgType = String(r[8] || "").trim().toLowerCase(); // I
      const pkgName = String(r[9] || "").trim();               // J
      const toDate  = parseExcelDate(r[7]);                    // H
      const subName = String(r[1] || "").trim();               // B

      groups[baseCode] ??= [];

      // ðŸ”´ BASE PACKAGE â†’ NEW ROW
      if (pkgType === "package" && pkgName) {

        const idx = groups[baseCode].length;
        const finalCode = idx === 0 ? baseCode : `${baseCode}-${idx}`;

        const obj = {
          code: finalCode,
          packages: [pkgName],
          expiryAmt: 0,
          toDate,
          subName
        };

        groups[baseCode].push(obj);
        expiryMap[finalCode] = obj;

        packageMap[pkgName] ??= 0;
        return;
      }

      // ðŸ”µ CHANNEL â†’ ADD TO LAST BASE PACKAGE ONLY
      if (pkgType === "channel" && pkgName) {
        const list = groups[baseCode];
        if (!list.length) return; // no base package yet

        list[list.length - 1].packages.push(pkgName);
        packageMap[pkgName] ??= 0;
      }
    });

    showExpirySummaryDialog();
    render();
  });
};






/* ===== PACKAGE INPUT BOX ===== */
function showExpirySummaryDialog() {
  let html = "";

  Object.keys(packageMap).sort().forEach(p => {
    html += `
      <div style="margin-bottom:8px">
        ${p}
        <input type="number" step="0.01"
          value="${packageMap[p]}"
          onchange="packageMap['${p}']=this.value">
      </div>`;
  });

  openModal(
    "Expiry Package Summary",
    html || "No packages found",
    () => {
      applyPackageAmounts(); // ðŸ”¥ auto calculate
    }
  );
}

/* ===== BillsSummaryDialog ===== */

function showBillsSummaryDialog() {
  let html = "";

  Object.keys(billAmountMap)
    .sort((a,b)=>a-b)
    .forEach(oldAmt => {
      html += `
        <div style="margin-bottom:8px">
          ${oldAmt}
          â†’
          <input type="number" step="0.01"
            value="${billAmountMap[oldAmt]}"
            onchange="billAmountMap['${oldAmt}']=this.value">
        </div>`;
    });

  openModal(
    "Bills Amount Summary",
    html || "No bill amounts found",
    () => {
      applyBillsFix();
    }
  );
}

/* ===== Package Amount ===== */
function applyPackageAmounts() {
  Object.values(expiryMap).forEach(o => {
    o.expiryAmt = o.packages.reduce(
      (s,p)=>s+(+packageMap[p]||0),0
    );
  });
  localStorage.setItem(
    "expiryPackageMap",
    JSON.stringify(packageMap)
  );
  render();
}
/* ===== Export Excel ===== */
function exportExcel() {

  if (
    Object.keys(billsMap).length === 0 &&
    Object.keys(expiryMap).length === 0
  ) {
    alert("No data to export");
    return;
  }

  const wb = XLSX.utils.book_new();

  /* =========================
     ðŸ“„ SHEET 1 : BILLS ONLY
     ========================= */
  const billsData = [
    ["Bill Date","Bills No","Code","Sub Name","User","Bills Amount"]
  ];

  Object.keys(billsMap).sort().forEach(code => {
    const obj = billsMap[code];
    if (!obj || !Array.isArray(obj.amounts)) return;

    const totalAmt = obj.amounts.reduce((a,b)=>a+b,0);

    billsData.push([
      obj.billDate || "",
      obj.billsNo || "",      
      code,  
      obj.subName || "",    
      obj.user || "",      
      totalAmt          // ðŸ”¥ NUMBER (not toFixed)
    ]);
  });

  const wsBills = XLSX.utils.aoa_to_sheet(billsData);

  // number format
  let r1 = XLSX.utils.decode_range(wsBills["!ref"]);
  for (let R = 1; R <= r1.e.r; ++R) {
    const c = wsBills["F" + (R+1)];
    if (c && typeof c.v === "number") c.z = "0.00";
  }

  XLSX.utils.book_append_sheet(wb, wsBills, "Bills Only");

  /* =========================
   ðŸ“„ SHEET 2 : EXPIRY ONLY (NON MATCH)
   ========================= */
const expiryData = [
  ["Code", "To Date", "Expiry Amount", "Bills Amount"]
];

Object.keys(expiryMap).sort().forEach(code => {

  const exp = expiryMap[code];
  if (!exp) return;

  const expAmt = Number(exp.expiryAmt) || 0;

  // Bills total
  let billAmt = 0;
  if (billsMap[code] && Array.isArray(billsMap[code].amounts)) {
    billAmt = billsMap[code].amounts.reduce((a,b)=>a+b,0);
  }

  // ðŸ”¥ FILTER: only NON MATCH
  if (Math.abs(expAmt - billAmt) < 0.01) return;

  expiryData.push([
    code,
    exp.toDate || "",
    expAmt,
    billAmt
  ]);
});

const wsExpiry = XLSX.utils.aoa_to_sheet(expiryData);

/* number format */
const range = XLSX.utils.decode_range(wsExpiry["!ref"]);
for (let R = 1; R <= range.e.r; ++R) {
  ["C","D"].forEach(col => {
    const cell = wsExpiry[col + (R+1)];
    if (cell && typeof cell.v === "number") {
      cell.z = "0.00";
    }
  });
}

XLSX.utils.book_append_sheet(wb, wsExpiry, "Expiry Non-Match");


  /* =========================
     SAVE FILE
     ========================= */
  XLSX.writeFile(wb, "Bills_Expiry_Report.xlsx");
}

window.exportExcel = exportExcel;

/* ===== Toggle Dark ===== */
function toggleDark(){
  document.body.classList.toggle("dark");
}



/* ===== Bills file ===== */
document.getElementById("billsFile").onchange = e => {
  readExcel(e.target.files[0], rows => {

    billsMap = {};
const savedBillsFix = JSON.parse(localStorage.getItem("billAmountMap") || "{}");
billAmountMap = { ...savedBillsFix };

    rows.slice(1).forEach(r => {

      const billsNo = String(r[0] || "").trim(); // ðŸ”¥ Column A
      const code = String(r[1] || "")
  	.trim()
  	.replace(/\s+/g,"")
 	 .toUpperCase();

	if (!isValidCode(code)) return;

      const amt = parseFloat(String(r[9]).replace(/,/g,""));
      if (isNaN(amt)) return;

      // ðŸ”¥ NEW FIELDS
      const billDate = parseExcelDate(r[7]); // H
      const user     = String(r[4] || "").trim(); // E
      const subName  = String(r[2] || "").trim(); // C

      if (!billsMap[code]) {
        billsMap[code] = {
	  billsNo: billsNo,
          amounts: [],
          billDate: billDate,
          user: user,
          subName: subName
        };
      }

      billsMap[code].amounts.push(amt);

      // UNIQUE AMOUNT FIX BOX
      if (!(amt in billAmountMap)) {
  billAmountMap[amt] = savedBillsFix[amt] ?? amt;
}

    });

    showBillsSummaryDialog();
    render();
  });
};


/* ===== Render Bills Fix===== */
function renderBillsFixBox() {
  const box = document.getElementById("billFixBox");
  let html = "";

  Object.keys(billAmountMap).sort((a,b)=>a-b).forEach(oldAmt => {
    html += `
      <div style="margin-bottom:6px">
        ${oldAmt}
        â†’
        <input type="number" step="0.01"
          value="${billAmountMap[oldAmt]}"
          onchange="billAmountMap['${oldAmt}']=this.value">
      </div>`;
  });

  box.innerHTML = html || "No bill amounts found";
}
/* ===== Apply Bills Fix===== */
function applyBillsFix() {
  Object.values(billsMap).forEach(o=>{
    o.amounts = o.amounts.map(v =>
      +billAmountMap[v] || v
    );
  });
  localStorage.setItem(
    "billAmountMap",
    JSON.stringify(billAmountMap)
  );
  render();
}




/* ===== Render table ===== */
function render() {
  const out = document.getElementById("out");
  let html = "";

  const allCodes = new Set([
    ...Object.keys(expiryMap),
    ...Object.keys(billsMap)
  ]);

  [...allCodes].sort().forEach(code => {

    const exp = expiryMap[code] || {};
    const billObj = billsMap[code] || {};
    const billArr = Array.isArray(billObj.amounts)
      ? billObj.amounts
      : [];

    const billAmt = billArr.reduce((a, b) => a + b, 0);

    const billDate = billObj.billDate || "";
    const toDate   = exp.toDate || "";
    const user     = billObj.user || "";
    const subName  = billObj.subName || exp.subName || "_Name not found_";

    const expAmt = Number(exp.expiryAmt) || 0;
    const diff   = expAmt - billAmt;

    const pkgText = (exp.packages || []).length
  ? exp.packages.map(p => "â€¢ " + String(p)).join("\n")
  : "No package assigned";
const displayName=billObj.subName || exp.subName || "_Name not available_";
const safePkgText = pkgText
  .replace(/"/g, "'")
  .replace(/\n/g, "&#10;");

html += `
<tr class="${Math.abs(diff) < 0.01 ? "" : "neg"}" data-code="${code}"
    data-packages="SubNo: ${code}&#10;Name: ${displayName}&#10;${safePkgText}">
  <td>${code}</td>  
  <td>${subName}</td>
  <td>${user}</td>
  <td>${billDate}</td>
  <td>${toDate}</td>
  <td>${expAmt.toFixed(2)}</td>
  <td>
    <input type="number" step="0.01" value="${billAmt}"
      oninput="recalc('${code}', this.value)">
  </td>
  <td class="diff">${diff.toFixed(2)}</td>
</tr>`;
  });

  if (allCodes.size === 0) {
    out.innerHTML =
      "<tr><td colspan='8'>Please upload files</td></tr>";
    return;
  }

  out.innerHTML = html;
  updateDashboard();

  document.getElementById("searchBox")?.dispatchEvent(new Event("input"));
  document.getElementById("filterMismatch")?.dispatchEvent(new Event("change"));
}



/* ===== DashBoard Update ===== */
function updateDashboard() {

  let totalBills = 0;
  let totalExpiry = 0;
  let nonMatch = 0;

  // Bills total
  Object.keys(billsMap).forEach(code => {
    const obj = billsMap[code];
    if (obj && Array.isArray(obj.amounts)) {
      totalBills += obj.amounts.reduce((a, b) => a + b, 0);
    }
  });

  // Expiry total + non match
  Object.keys(expiryMap).forEach(code => {
    const expAmt = Number(expiryMap[code]?.expiryAmt || 0);
    totalExpiry += expAmt;

    let billAmt = 0;
    if (billsMap[code] && Array.isArray(billsMap[code].amounts)) {
      billAmt = billsMap[code].amounts.reduce((a, b) => a + b, 0);
    }

    if (Math.abs(expAmt - billAmt) >= 0.01) {
      nonMatch++;
    }
  });

  document.getElementById("dashBills").textContent =
    totalBills.toFixed(2);

  document.getElementById("dashExpiry").textContent =
    totalExpiry.toFixed(2);

  document.getElementById("dashNonMatch").textContent =
    nonMatch;

  const allCodes = new Set([
    ...Object.keys(expiryMap),
    ...Object.keys(billsMap)
  ]);

  const customerCount = allCodes.size;
  document.getElementById("dashCustomers").textContent =
    customerCount;
}



/* ===== ToDate ko Excel serial ===== */
function parseExcelDate(val) {
  if (val === undefined || val === null || val === "") return "";

  // Case 1: Already string date
  if (typeof val === "string") {
    return val;
  }

  // Case 2: Excel serial number
  if (typeof val === "number") {
    const utc_days = Math.floor(val - 25569);
    const utc_value = utc_days * 86400;
    const date_info = new Date(utc_value * 1000);
    return date_info.toLocaleDateString("en-GB"); // DD-MM-YYYY
  }

  return "";
}


/* ===== Recalculate difference ===== */
function recalc(code, val) {

  const row = document.querySelector(`tr[data-code="${code}"]`);
  if (!row) return;

  const diffCell = row.querySelector(".diff");

  const billAmt = parseFloat(val) || 0;

  // ðŸ”¥ billsMap object safe update
 	 if (!billsMap[code]) {
    		billsMap[code] = {
 		 billsNo: "",
 		amounts: [],
  		billDate: "",
  		user: "",
  		subName: ""
	};
  }

  // Manual edit = overwrite amounts
  billsMap[code].amounts = [billAmt];

  const expAmt = Number(expiryMap[code]?.expiryAmt || 0);
  const diff = expAmt - billAmt;

  diffCell.textContent = diff.toFixed(2);
  row.className = Math.abs(diff) < 0.01 ? "" : "neg";
	
	updateDashboard();
}

window.applyBillsFix = applyBillsFix;

/* ===== Search Filter ===== */
document.getElementById("searchBox").addEventListener("input", function () {
  const q = this.value.toLowerCase();

  document.querySelectorAll("#out tr").forEach(tr => {
    tr.style.display =
      tr.textContent.toLowerCase().includes(q)
        ? ""
        : "none";
  });
});

/* ===== Non-Match Filter ===== */
document.getElementById("filterMismatch").addEventListener("change", function () {
  document.querySelectorAll("#out tr").forEach(tr => {
    const diff = parseFloat(
      tr.querySelector(".diff")?.textContent || 0
    );

    tr.style.display =
      this.checked && Math.abs(diff) < 0.01
        ? "none"
        : "";
  });
});
const tooltip = document.getElementById("rowTooltip");

document.addEventListener("mousemove", e => {
  if (tooltip.style.opacity === "1") {
    tooltip.style.left = e.clientX + 16 + "px";
    tooltip.style.top  = e.clientY + 16 + "px";
  }
});

document.addEventListener("mouseover", e => {
  const tr = e.target?.closest?.("tr[data-packages]");
  if (!tr) return;

  tooltip.innerHTML = tr.dataset.packages.replace(/&#10;/g, "<br>");
  tooltip.style.opacity = "1";
  tooltip.style.transform = "translateY(0)";
});

document.addEventListener("mouseout", e => {
  const tr = e.target?.closest?.("tr[data-packages]");
  if (!tr) return;

  tooltip.style.opacity = "0";
  tooltip.style.transform = "translateY(6px)";
});

window.addEventListener("scroll", () => {
  tooltip.style.opacity = "0";
});


</script>
<div id="modalOverlay" class="modal-overlay">
  <div class="modal-box">
    <h4 id="modalTitle"></h4>
    <div id="modalContent"></div>

    <div class="modal-actions">
      <button id="modalApply">Apply</button>
      <button onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

</body>
</html>
